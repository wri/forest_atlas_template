define(["mainmodel","dojo/number","toolsconfig","root/languages","dojo/_base/array","common/lib/highcharts"],function(e,t,a,n,i){a.initialize();var o=a.getConfig(),s=!1;return Highcharts.setOptions({chart:{style:{fontFamily:"Arial"}}}),require(["common/lib/exporting"]),{formatTreeCoverData:function(t,a,i,s,r,l){function c(e){return 0!==e}var u,d,h,p,g=function(e){return e*a*a/1e4},f=o.analysisConfig.totalLoss,v=f.labels,b=this.fromBounds(f.bounds),y=this.fromBounds(i.bounds),m=e.getVM(),x=m?m.currentLanguage():l?l.lang:"en",C=n[x].analysisChartLabels[i.labelKey],L=[],A=[];if(r)L.push({name:C[0],data:t.slice(1).map(g)}),A.push(i.colors[0]);else for(h=0;h<y.length;h++){for(d=[],p=0;p<b.length;p++)u=s.encode(b[p],y[h]),d.push(t[u]||0);d.some(c)&&(L.push({name:C[h],data:d.map(g)}),A.push(i.colors[h]))}this.renderTreeCoverChart(i.titleKey,L,A,v,C,l)},renderTreeCoverChart:function(t,a,i,o,r,l){var c,u,d,h,p,g;p=e.getVM(),u=p?p.currentLanguage():l?l.lang:"en",g=n[u][t],d=document.querySelector("#results-header .title"),c=this.cleanTitle(d?d.innerHTML:""),h="#"+(l?l.container:"analysis-chart"),$(h).highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null,type:"bar"},exporting:{chartOptions:{title:{text:c+" - "+g}}},title:{useHTML:!0,text:g},xAxis:{categories:o,maxPadding:.5,title:{text:null}},yAxis:{stackLabels:{enabled:!0},title:{text:null}},legend:{enabled:!0,verticalAlign:"bottom"},plotOptions:{series:{stacking:"normal"}},series:a,colors:i,credits:{enabled:!1}}),s||this.addCSVExportOption()},renderTotalLossData:function(t,a,i){var r,l,c,u,d,h,p=function(e){return e*a*a/1e4},g=o.analysisConfig.totalLoss,f=g.labels,v=[];100!==a&&(t=t.map(p)),d=e.getVM(),l=d?d.currentLanguage():i?i.lang:"en",h=n[l].analysisLossChartTitle,c=document.querySelector("#results-header .title"),r=this.cleanTitle(c?c.innerHTML:""),u="#"+(i?i.container:"analysis-chart"),v.push({name:h,data:t.slice(1)}),$(u).highcharts({chart:{type:"bar"},exporting:{chartOptions:{title:{text:r+" - "+h}}},title:{useHTML:!0,text:h},xAxis:{categories:f,maxPadding:.5,title:{text:null}},yAxis:{title:{text:null}},series:v,colors:["#cf5188"],credits:{enabled:!1}}),s||this.addCSVExportOption()},renderTotalGainAndLossData:function(a,i,o,s){var r,l,c,u=function(e){return e*o*o/1e4},d=e.getVM(),h=d?d.currentLanguage():s?s.lang:"en";100!==o&&(a=a.map(u),i=i.map(u)),i&&i.shift(),r=a?a[1]:"N/A",l=i?i.reduce(function(e,t){return e+t},0):"N/A",r=t.format(r),l=t.format(l);var p=s?s.container:"analysis-chart";c="<div id='"+p+"'>",c+="<section class='result-badge loss'><div>"+n[h].totalLossAnalysis+"</div>",c+="<div class='loss-count'>"+l+" ha</div>",c+="</section>",c+="<section class='result-badge gain'><div>"+n[h].totalGainAnalysis+"</div>",c+="<div class='gain-count'>"+r+" ha</div>",c+="</section>",c+="</div>",$("#"+p).replaceWith(c)},renderLandCoverComposition:function(t,a,i){var r,l,c,u,d,h,p=function(e){return e*a*a/1e4},g=o.analysisConfig.landCover,f=g.colors,v=[],b=[];d=e.getVM(),l=d?d.currentLanguage():i?i.lang:"en",h=n[l].analysisLCComposition,titleNode=document.querySelector("#results-header .title"),r=titleNode?titleNode.innerHTML:"",u=n[l].analysisChartLabels.landCover,100!==a&&(t=t.map(p)),t=t.slice(1);for(var y=0,m=t.length;m>y;y++)0!==t[y]&&b.push({name:u[y],y:t[y],color:f[y]});c="#"+(i?i.container:"analysis-chart"),v.push({type:"pie",name:h,data:b}),$(c).highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},exporting:{chartOptions:{title:{text:h}}},title:{useHTML:!0,text:r?null:h},plotOptions:{pie:{allowPointSelect:!0,showInLegend:!0,cursor:"pointer",dataLabels:{enabled:!1}}},series:v,credits:{enabled:!1}}),s||this.addCSVExportOption()},renderFireData:function(t,a){var i,o,s=t[0].features,r=e.getVM(),l="";i=r?r.currentLanguage():a?a.lang:"en",o=a?a.container:"analysis-chart",l+="<div id='"+o+"'><section class='result-badge fires'><div>"+n[i].analysisChartLabels.activeFires.start+"</div>",l+="<div class='fire-count'>"+(s.length||0)+"</div>",l+="<div class='fire-count'>"+n[i].analysisChartLabels.activeFires.active+"</div>",l+="<div>"+n[i].analysisChartLabels.activeFires.end+"</div></section></div>",$("#"+o).replaceWith(l)},renderUnavailable:function(e){var t,a="<div id='analysis-chart'><section class='unavailable-badge'>";a+="<div>There is no data for this category in this area.</div>",a+="</section></div>",t="#"+(e?e.container:"analysis-chart"),$("#analysis-chart").replaceWith(a)},fromBounds:function(e){if(2!==e.length)return e;var t=[],a=e[0],n=e[1];for(a;n>=a;a++)t.push(a);return t},addCSVExportOption:function(){if(!s){var e=this;s=!0,require(["toolsmodel"],function(t){function a(){var t,a,o=document.querySelector("#results-header .title").innerHTML,s=this.options.chart.type,r=e.cleanTitle(o)+" - ",l=this.userOptions,c=this.series,u=[],d=[],h=[];"pie"===s?(r+=c[0].name,u.push(r+"\r\n"),d=["category","value"],u.push(d.join(",")),i.forEach(c[0].data,function(e){u.push(e.name+","+e.y)}),t=u.join("\r\n")):l&&"SLOPE_POTENTIAL"===l.analysis?(a=app.config.slopeAnalysisRestorationOptions,slopeSelectedPercent=n.slopeActiveOption().label,r+=this.title?this.title.textStr:"",u.push(r),d=["Potential according to slope",slopeSelectedPercent],u.push(d.join(",")),i.forEach(this.xAxis[0].categories,function(e,t){h.push(a[t].replace(",","")),i.forEach(c,function(e){h.push(e.yData[t])}),u.push(h.join(",")),h=[]}),t=u.join("\r\n")):(r+=this.title?this.title.textStr:"",u.push(r),d=i.map(c,function(e){return e.name}),d.unshift("year"),u.push(d.join(",")),i.forEach(this.xAxis[0].categories,function(e,t){h.push(e),i.forEach(c,function(e){h.push(e.yData[t])}),u.push(h.join(",")),h=[]}),t=u.join("\r\n")),t&&e.downloadCSV(t)}var n=t.getVM();Highcharts.getOptions().exporting.buttons.contextButton.menuItems.push({text:"Download CSV file",onclick:a})})}},downloadCSV:function(e){var t,a="data:application/vnd.ms-excel;base64,",n="text/csv;charset=utf-8;",i=document.createElement("a"),o=document.querySelector(".analysis-options-select").value+".csv";window.navigator.msSaveOrOpenBlob?(t=this.base64toBlob(this.base64_encode(e),n),navigator.msSaveBlob(t,o)):saveAs&&new Blob?(t=this.base64toBlob(this.base64_encode(e),n),saveAs(t,o)):""===i.download?(i.href=a+this.base64_encode(e),i.target="_blank",i.download=o,i.click()):window.open(a+this.base64_encode(data))},base64toBlob:function(e,t){t=t||"";for(var a=1024,n=atob(e),i=n.length,o=Math.ceil(i/a),s=new Array(o),r=0;o>r;++r){for(var l=r*a,c=Math.min(l+a,i),u=new Array(c-l),d=0,h=l;c>h;++d,++h)u[d]=n[h].charCodeAt(0);s[r]=new Uint8Array(u)}return new Blob(s,{type:t})},base64_encode:function(e){var t,a,n,i,o,s,r,l,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,d=0,h="",p=[];if(!e)return e;do t=e.charCodeAt(u++),a=e.charCodeAt(u++),n=e.charCodeAt(u++),l=t<<16|a<<8|n,i=l>>18&63,o=l>>12&63,s=l>>6&63,r=63&l,p[d++]=c.charAt(i)+c.charAt(o)+c.charAt(s)+c.charAt(r);while(u<e.length);h=p.join("");var g=e.length%3;return(g?h.slice(0,g-3):h)+"===".slice(g||3)},cleanTitle:function(e){for(var t,a=/\(([^()]+)\)/g;null!==(t=a.exec(e));)t[0].indexOf("1 of")>-1&&(e=e.slice(0,t.index));return e}}});