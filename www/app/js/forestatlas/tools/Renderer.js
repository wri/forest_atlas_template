define(["mainmodel","dojo/number","toolsconfig","root/languages","dojo/_base/array","common/lib/highcharts"],function(e,t,a,n,i){a.initialize();var r=a.getConfig(),o=!1;return Highcharts.setOptions({chart:{style:{fontFamily:"Arial"}}}),require(["common/lib/exporting"]),{formatTreeCoverData:function(t,a,i,o,s,l){function c(e){return 0!==e}var d,u,h,g,p=function(e){return e*a*a/1e4},v=r.analysisConfig.totalLoss,f=v.labels,b=this.fromBounds(v.bounds),m=this.fromBounds(i.bounds),y=e.getVM(),x=y?y.currentLanguage():l?l.lang:"en",C=n[x].analysisChartLabels[i.labelKey],L=[],A=[];if(s)L.push({name:C[0],data:t.slice(1).map(p)}),A.push(i.colors[0]);else for(h=0;h<m.length;h++){for(u=[],g=0;g<b.length;g++)d=o.encode(b[g],m[h]),u.push(t[d]||0);u.some(c)&&(L.push({name:C[h],data:u.map(p)}),A.push(i.colors[h]))}this.renderTreeCoverChart(i.titleKey,L,A,f,C,l)},renderTreeCoverChart:function(t,a,i,r,s,l){var c,d,u,h,g,p;g=e.getVM(),d=g?g.currentLanguage():l?l.lang:"en",p=n[d][t],u=document.querySelector("#results-header .title"),c=this.cleanTitle(u?u.innerHTML:""),h="#"+(l?l.container:"analysis-chart"),$(h).highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:null,type:"bar"},exporting:{chartOptions:{title:{text:c+" - "+p}}},title:{useHTML:!0,text:p},xAxis:{categories:r,maxPadding:.5,title:{text:null}},yAxis:{stackLabels:{enabled:!0},title:{text:null}},legend:{enabled:!0,verticalAlign:"bottom"},plotOptions:{series:{stacking:"normal"}},series:a,colors:i,credits:{enabled:!1}}),o||this.addCSVExportOption()},renderTotalLossData:function(t,a,i){var s,l,c,d,u,h,g=function(e){return e*a*a/1e4},p=r.analysisConfig.totalLoss,v=p.labels,f=[];100!==a&&(t=t.map(g)),u=e.getVM(),l=u?u.currentLanguage():i?i.lang:"en",h=n[l].analysisLossChartTitle,c=document.querySelector("#results-header .title"),s=this.cleanTitle(c?c.innerHTML:""),d="#"+(i?i.container:"analysis-chart"),f.push({name:h,data:t.slice(1)}),$(d).highcharts({chart:{type:"bar"},exporting:{chartOptions:{title:{text:s+" - "+h}}},title:{useHTML:!0,text:h},xAxis:{categories:v,maxPadding:.5,title:{text:null}},yAxis:{title:{text:null}},series:f,colors:["#cf5188"],credits:{enabled:!1}}),o||this.addCSVExportOption()},renderTotalGainAndLossData:function(a,i,r,o){var s,l,c,d=function(e){return e*r*r/1e4},u=e.getVM(),h=u?u.currentLanguage():o?o.lang:"en";100!==r&&(a=a.map(d),i=i.map(d)),i&&i.shift(),s=a?a[1]:"N/A",l=i?i.reduce(function(e,t){return e+t}):"N/A",s=t.format(s),l=t.format(l);var g=o?o.container:"analysis-chart";c="<div id='"+g+"'>",c+="<section class='result-badge loss'><div>"+n[h].totalLossAnalysis+"</div>",c+="<div class='loss-count'>"+l+" ha</div>",c+="</section>",c+="<section class='result-badge gain'><div>"+n[h].totalGainAnalysis+"</div>",c+="<div class='gain-count'>"+s+" ha</div>",c+="</section>",c+="</div>",$("#"+g).replaceWith(c)},renderLandCoverComposition:function(t,a,i){var s,l,c,d,u,h,g=function(e){return e*a*a/1e4},p=r.analysisConfig.landCover,v=p.colors,f=[],b=[];u=e.getVM(),l=u?u.currentLanguage():i?i.lang:"en",h=n[l].analysisLCComposition,titleNode=document.querySelector("#results-header .title"),s=titleNode?titleNode.innerHTML:"",d=n[l].analysisChartLabels.landCover,100!==a&&(t=t.map(g)),t=t.slice(1);for(var m=0,y=t.length;y>m;m++)0!==t[m]&&b.push({name:d[m],y:t[m],color:v[m]});c="#"+(i?i.container:"analysis-chart"),f.push({type:"pie",name:h,data:b}),$(c).highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},exporting:{chartOptions:{title:{text:h}}},title:{useHTML:!0,text:s?null:h},plotOptions:{pie:{allowPointSelect:!0,showInLegend:!0,cursor:"pointer",dataLabels:{enabled:!1}}},series:f,credits:{enabled:!1}}),o||this.addCSVExportOption()},renderFireData:function(t,a){var i,r,o=t[0].features,s=e.getVM(),l="";i=s?s.currentLanguage():a?a.lang:"en",r=a?a.container:"analysis-chart",l+="<div id='"+r+"'><section class='result-badge fires'><div>"+n[i].analysisChartLabels.activeFires.start+"</div>",l+="<div class='fire-count'>"+(o.length||0)+"</div>",l+="<div class='fire-count'>"+n[i].analysisChartLabels.activeFires.active+"</div>",l+="<div>"+n[i].analysisChartLabels.activeFires.end+"</div></section></div>",$("#"+r).replaceWith(l)},renderUnavailable:function(e){var t,a="<div id='analysis-chart'><section class='unavailable-badge'>";a+="<div>There is no data for this category in this area.</div>",a+="</section></div>",t="#"+(e?e.container:"analysis-chart"),$("#analysis-chart").replaceWith(a)},fromBounds:function(e){if(2!==e.length)return e;var t=[],a=e[0],n=e[1];for(a;n>=a;a++)t.push(a);return t},addCSVExportOption:function(){function e(){var e,a=document.querySelector("#results-header .title").innerHTML,n=this.options.chart.type,r=t.cleanTitle(a)+" - ",o=this.series,s=[],l=[],c=[];"pie"===n?(r+=o[0].name,s.push(r+"\r\n"),l=["category","value"],s.push(l.join(",")),i.forEach(o[0].data,function(e){s.push(e.name+","+e.y)}),e=s.join("\r\n")):(r+=this.title.textStr,s.push(r),l=i.map(o,function(e){return e.name}),l.unshift("year"),s.push(l.join(",")),i.forEach(this.xAxis[0].categories,function(e,t){c.push(e),i.forEach(o,function(e){c.push(e.yData[t])}),s.push(c.join(",")),c=[]}),e=s.join("\r\n")),e&&t.downloadCSV(e)}if(!o){var t=this;o=!0,Highcharts.getOptions().exporting.buttons.contextButton.menuItems.push({text:"Download CSV file",onclick:e})}},downloadCSV:function(e){var t,a="data:application/vnd.ms-excel;base64,",n="text/csv;charset=utf-8;",i=document.createElement("a"),r=document.querySelector(".analysis-options-select").value+".csv";window.navigator.msSaveOrOpenBlob?(t=this.base64toBlob(this.base64_encode(e),n),navigator.msSaveBlob(t,r)):saveAs&&new Blob?(t=this.base64toBlob(this.base64_encode(e),n),saveAs(t,r)):""===i.download?(i.href=a+this.base64_encode(e),i.target="_blank",i.download=r,i.click()):window.open(a+this.base64_encode(data))},base64toBlob:function(e,t){t=t||"";for(var a=1024,n=atob(e),i=n.length,r=Math.ceil(i/a),o=new Array(r),s=0;r>s;++s){for(var l=s*a,c=Math.min(l+a,i),d=new Array(c-l),u=0,h=l;c>h;++u,++h)d[u]=n[h].charCodeAt(0);o[s]=new Uint8Array(d)}return new Blob(o,{type:t})},base64_encode:function(e){var t,a,n,i,r,o,s,l,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=0,u=0,h="",g=[];if(!e)return e;do t=e.charCodeAt(d++),a=e.charCodeAt(d++),n=e.charCodeAt(d++),l=t<<16|a<<8|n,i=l>>18&63,r=l>>12&63,o=l>>6&63,s=63&l,g[u++]=c.charAt(i)+c.charAt(r)+c.charAt(o)+c.charAt(s);while(d<e.length);h=g.join("");var p=e.length%3;return(p?h.slice(0,p-3):h)+"===".slice(p||3)},cleanTitle:function(e){for(var t,a=/\(([^()]+)\)/g;null!==(t=a.exec(e));)t[0].indexOf("1 of")>-1&&(e=e.slice(0,t.index));return e}}});