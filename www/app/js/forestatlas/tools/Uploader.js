define(["mapui","mapconfig","toolsmodel","dojo/sniff","esri/request","esri/graphic","dijit/registry","dojo/_base/array","dojo/store/Memory","dojo/dom-construct","dijit/form/ComboBox","esri/geometry/Polygon","atlas/tools/MapAssets","esri/geometry/scaleUtils","common/lib/terraformer.min"],function(e,t,o,a,r,n,i,s,l,d,u,c,m,p){"use strict";var g={badType:"We currently do not support the file type you provided, file type must be .zip, .geojson, or .json.",failedRequest:"We are unable to process your shapefile or geojson file at this time.  Please try again later.",browserCompatability:"Your browser may not support this feature, try again on the latest version of Firefox, Chrome, IE, or Safari.",invalidJson:"Please make sure your geojson is valid, you can validate it here: http://geojsonlint.com",convert:"We are unable to convert your geojson file, please make sure it is valid geojson(http://geojsonlint.com)."},f={beginUpload:function(o){var n=o.target?o.target:o.srcElement;if(""!==n.value){var i,s,l,d=n.value.toLowerCase(),u=t.getConfig(),c=d.length,m=e.getMap();if(a("ie")){var f=d.split("\\");d=f[f.length-1]}if(".json"===d.slice(c-5,c)||".geojson"===d.slice(c-8,c))return void this.uploadGeoJson(n);if(".zip"!==d.slice(c-4,c))return void alert(g.badType);d=d.split("."),d=d[0].replace("c:\\fakepath\\",""),s={name:d,generalize:!0,targetSR:m.spatialReference,maxRecordCount:1e3,reducePrecision:!0,numberOfDigitsAfterDecimal:0,enforceInputFileSizeLimit:!0,enforceOutputJsonSizeLimit:!0},l=p.getExtentForScale(m,4e4),s.maxAllowableOffset=l.getWidth()/m.width,i={publishParameters:JSON.stringify(s),"callback.html":"textarea",filetype:"shapefile",f:"json"},r({url:u.portalGenerateFeaturesURL,content:i,form:document.getElementById("uploadForm"),handleAs:"json",load:this.uploadSuccess.bind(this),error:this.uploadError})}},uploadError:function(){alert(g.failedRequest)},uploadSuccess:function(e){var t,a=document.getElementById("uploadNameSelectContainer"),r=e.featureCollection,n=(o.getVM(),[]),i=this;s.forEach(r.layers[0].layerDefinition.fields,function(e){n.push({name:e.name,id:e.alias})}),d.create("div",{id:"dropdownContainerName",innerHTML:"<div id='uploadComboNameWidget'></div>"},a,"first"),t=new l({data:n}),new u({id:"uploadComboNameWidget",value:"-- Choose name field --",store:t,searchAttr:"name",onChange:function(e){e&&(i.addToMap(e,r.layers[0].featureSet),i.resetForm())}},"uploadComboNameWidget")},uploadGeoJson:function(e){var t,o,a,r;t=function(){try{o=JSON.parse(a.result)}catch(e){alert(g.invalidJson)}o&&this.convertGeoJsonToEsriGeo(o)};try{r=e.files[0],a=new FileReader,a.onload=t.bind(this),a.readAsText(r)}catch(n){alert(g.browserCompatability)}},convertGeoJsonToEsriGeo:function(e){var t,o,a=[],r=this;require(["common/lib/terraformer-arcgis-parser-1.0.4.min"],function(){try{t=Terraformer.ArcGIS.convert(e)}catch(n){alert(g.convert)}if(t&&(s.forEach(t,function(e,t){o=new c,"[object Array]"===Object.prototype.toString.call(e.geometry)?s.forEach(e.geometry,function(e){e.rings?s.forEach(e.rings,function(e){o.addRing(e)}):s.forEach(e.paths,function(e){o.addRing(e)})}):e.geometry.rings?s.forEach(e.geometry.rings,function(e){o.addRing(e)}):s.forEach(e.geometry.paths,function(e){o.addRing(e)}),o.rings.length>0&&a.push({polygon:o,attributes:e.attributes,id:t})}),a.length>0)){var i,m=document.getElementById("uploadNameSelectContainer"),p=[];d.create("div",{id:"dropdownContainerName",innerHTML:"<div id='uploadComboNameWidget'></div>"},m,"first");for(var f in a[0].attributes)p.push({name:f,id:f});i=new l({data:p}),new u({id:"uploadComboNameWidget",value:"-- Choose name field --",store:i,searchAttr:"name",onChange:function(e){e&&(r.addGeoJsonToMap(e,a),r.resetForm())}},"uploadComboNameWidget")}})},addGeoJsonToMap:function(t,a){var r,i,l,d,u=m.getDrawUploadSymbol(),c=e.getMap(),p=c.getLayer("customGraphicsLayer"),g=o.getVM();d=m.getNextAvailableId(p.graphics,"CustomFeatureId"),s.forEach(a,function(e){r=e.attributes,r.Custom_Title=e.attributes[t],r.CustomFeatureId=d++,i=new n(e.polygon,u,r),l=l?l.union(e.polygon.getExtent()):e.polygon.getExtent(),p.add(i)}),c.setExtent(l,!0),document.uploadForm.reset(),g.analyzeToolsVisible(!1),g.showUploadTools(!1),ga("A.send","event","Event","Upload","User successfully uploaded a GeoJSON file.")},addToMap:function(t,o){var a,r,i,l,d=m.getDrawUploadSymbol(),u=e.getMap(),p=u.getLayer("customGraphicsLayer");l=m.getNextAvailableId(p.graphics,"CustomFeatureId"),s.forEach(o.features,function(e){e.attributes.CustomFeatureId=l++,e.attributes.Custom_Title=e.attributes[t],a=new c(e.geometry),r=new n(a,d,e.attributes),i=i?i.union(a.getExtent()):a.getExtent(),p.add(r)}),u.setExtent(i,!0),ga("A.send","event","Event","Upload","User successfully uploaded a shapefile.")},resetForm:function(){var e=o.getVM();i.byId("uploadComboNameWidget")&&i.byId("uploadComboNameWidget").destroy(),document.getElementById("dropdownContainerName")&&d.destroy("dropdownContainerName"),document.uploadForm.reset(),e.analyzeToolsVisible(!1),e.showUploadTools(!1)}};return f});