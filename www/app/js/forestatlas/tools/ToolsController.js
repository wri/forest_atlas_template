define(["declare","hash","ioquery","ko","toolsmodel","mapmodel","mapconfig","toolsconfig","registry","style","dom","array","combobox","menuitem","menuseparator","memory","class","query","find","findparameters","number","all","string","topic","mainmodel","cookie","win","mapui","grid","ifrs","uifactory","construct","attr","esriquery","querytask","on","connect","graphic","edit","draw","undomanager","delete","update","add","attachmenteditor","filteringselect","screenutils","extent","screenpoint","dynamicMapLayer","layerDrawingOptions","featureLayer","webMercatorUtils","esrirequest","tiledmap","arcgisutil","atlas/tools/DrawTools","atlas/tools/Uploader","atlas/tools/Helper","esri/layers/RasterFunction"],function(e,a,t,i,r,o,n,s,l,c,d,y,g,u,p,f,h,b,m,v,L,k,I,C,w,M,j,T,V,x,E,B,_,D,P,F,G,H,O,A,S,N,z,U,W,R,q,J,Q,Z,K,X,Y,$,ee,ae,te,ie,re,oe){return e(null,{UIcreationComplete:function(e){b(".hideOnLoad").forEach(function(e){h.remove(e,"hideOnLoad")}),r.initialize("mapTools",e);var a=(T.getMap(),r.getVM()),t=T.getWebMapResponse();ae.getLegendLayers(t);addthis.init(),this.addEvents(),te.init(),re.isMobile()||l.byId("legendTitlePane").toggle();var o=l.byId("basemapGallery");o.loaded?i.applyBindings(a,document.getElementById("basemapGallery")):F.once(o,"load",function(){i.applyBindings(a,document.getElementById("basemapGallery"))})},addEvents:function(){var e=r.getVM(),a=T.getMap(),t=a.getLayer("customGraphicsLayer"),i=this;F(d.byId("analyze-button"),"click",function(){e.analyzeToolsVisible(!e.analyzeToolsVisible()),e.shareToolsVisible()&&e.shareToolsVisible(!1),e.basemapGalleryVisible()&&e.basemapGalleryVisible(!1),e.analyzeToolsVisible()&&t.graphics.length>0?c.set("clearAllFeatures","display","block"):c.set("clearAllFeatures","display","none")}),F(d.byId("share-button"),"click",function(){e.shareToolsVisible(!e.shareToolsVisible()),e.analyzeToolsVisible()&&e.analyzeToolsVisible(!1),e.basemapGalleryVisible()&&e.basemapGalleryVisible(!1),ga("A.send","event","Event","Share Button","User clicked the share button.")}),F(d.byId("basemap-button"),"click",function(){e.basemapGalleryVisible(!e.basemapGalleryVisible()),e.shareToolsVisible()&&e.shareToolsVisible(!1),e.analyzeToolsVisible()&&e.analyzeToolsVisible(!1)}),F(d.byId("uploadFeatures"),"click",function(){e.showUploadTools(!e.showUploadTools()),e.showUploadTools()&&ga("A.send","event","Event","Upload","User clicked the upload button.")}),F(d.byId("drawFeatures"),"click",function(){te.toggle(),e.analyzeToolsVisible(!1)}),F(document.uploadForm,"change",function(e){ie.beginUpload(e)}),F(d.byId("mobileToggle"),"click",function(){var e="block"===c.get("mobileMenu","display")?"none":"block";c.set("mobileMenu","display",e)}),F(d.byId("closeLayersButton"),"click",function(){i.toggleLayerPanel()}),F(d.byId("openLayersButton"),"click",function(){i.toggleLayerPanel()}),F(d.byId("clearAllFeatures"),"click",function(){t.clear(),c.set("clearAllFeatures","display","none")}),F(d.byId("mapThemeLink"),"mouseover",function(){e.showMapThemes(!0)}),F(d.byId("mapThemeLink"),"mouseout",function(){e.showMapThemes(!1)}),C.subscribe("changeLayout",function(e){e||"block"===c.get("mobileMenu","display")&&c.set("mobileMenu","display","none")})},toggleLayerPanel:function(){var e=re.isMobile()?window.innerWidth-1:400,a=0===c.get("toolsContainer","width")?e:0,t=l.byId("stackContainer");if(c.set("toolsContainer","width",a+"px"),c.set(t.domNode,"left",a+"px"),l.byId("mainBorderContainer").resize(),0===a)c.set("closeLayersButton","display","none"),c.set("openLayersButton","display","block");else if(c.set("closeLayersButton","display","block"),c.set("openLayersButton","display","none"),dijit.byId("accordionContainer").resize(),re.isMobile()){var i=dijit.byId("accordionContainer").get("selectedChildWidget").id,r="layersCP"===i?"forestLossLayers":"layersCP";dijit.byId("accordionContainer").selectChild(r),setTimeout(function(){dijit.byId("accordionContainer").selectChild(i)},0)}},resetLayerPanel:function(){var e=l.byId("stackContainer"),a=400;c.set("toolsContainer","width",a+"px"),c.set(e.domNode,"left",a+"px"),l.byId("mainBorderContainer").resize(),c.set("closeLayersButton","display","block"),c.set("openLayersButton","display","none"),dijit.byId("accordionContainer").resize()},changeLayerVisibility:function(e,a){var t=T.getMap(),i=a.layerId,r=t.getLayer(i),o=e[0];o?r.show():r.hide()},clickLayerVisibility:function(e,a){var t=e[0];t.stopPropagation()},clickLayerLegend:function(e,a){var t=T.getMap();t.infoWindow.hide();var i="legendDiv_"+a.layerId;a.layerId;b(".selectedLegendItem").forEach(function(e){h.remove(e,"selectedLegendItem")}),h.add(i,"selectedLegendItem"),require(["toolsevents"],function(e){var a=e.getEvents();C.publish(a.clearHighlight)})},highlighGraphic:function(e){require(["toolsevents"],function(a){var t=a.getEvents();C.publish(t.clearHighlight);var i,r=T.getMap(),o=new H(e[0]),n=e[0].type;switch(n){case"point":i=r.getLayer("highlightGraphicsLayerPoint");break;case"polyline":i=r.getLayer("highlightGraphicsLayerLine");break;case"polygon":i=r.getLayer("highlightGraphicsLayerPoly")}i.add(o)})},clearHighlight:function(){var e=T.getMap();e.getLayer("highlightGraphicsLayerPoint").clear(),e.getLayer("highlightGraphicsLayerLine").clear(),e.getLayer("highlightGraphicsLayerPoly").clear(),e.graphics.clear()},showMoreOptions:function(e){},transparencyChange:function(e,a,t){for(var i=0;i<e.length;i++){var r=T.getMap(),n=100-a,s=r.getLayer(e[i]),l=o.getVM().layersDrawingOption(),c=new K;if(c.transparency=n,t.length>1)for(var d=0;d<t.length;d++)l[d]=c;else l[t]=c;o.getVM().layersDrawingOption(l),s.setLayerDrawingOptions(l)}},toggleMapLayer:function(e,a,t){var i=o.getVM(),r=i.currentActiveLayer().id,n=b("#layersCP .dijitCheckBox");0==a?(n[t].style.backgroundImage="none",d.byId("sliderContainerDiv"+t).style.display="none",d.byId("sliderText"+t).style.display="none",d.byId("sliderTitleDiv"+t).style.color="#cfcfcf"):1==a&&(n[t].style.backgroundImage="url('app/images/ico-checkmark.png')",d.byId("sliderContainerDiv"+t).style.display="block",d.byId("sliderText"+t).style.display="block",d.byId("sliderTitleDiv"+t).style.color="#000");for(var s=0;s<e.length;s++){var l=T.getMap(),c=l.getLayer(e[s]),y=c.id+"_"+t,g=l._layers[y];g&&(a?c.id==r&&g.show():g.hide());for(var u=c.createDynamicLayerInfosFromLayerInfos(),p=[],f=0;f<u.length;f++)p[f]=f;var h=p.indexOf(t),m=c.visibleLayers.indexOf(h);a?c.visibleLayers.push(t):c.visibleLayers.splice(m,1);var f,v=c.visibleLayers.length,L=[],k={};for(f=0;v>f;f++)k[c.visibleLayers[f]]=0;for(f in k)L.push(Number(f));0==L.length&&L.push(-1),c.visibleLayers=L,c.setVisibleLayers(c.visibleLayers),l.graphics.refresh()}},toggleExtraLayers:function(e,a,t){var i,o,s,l="#"+t,c=e?"block":"none",d=e?"#000":"#CFCFCF",g=n.getConfig(),u=w.getVM(),p=(r.getVM(),u.currentLanguage()),f=T.getMap();if(b(l+" .dijitCheckBox")[0].style.backgroundImage=e?"url('app/images/ico-checkmark.png')":c,b(l+" .sliderContainer")[0].style.display=c,b(l+" .sliderText")[0].style.display=c,b(l+" .sliderTitleDiv")[0].style.color=d,s=b(l+" .tools-container"),s.length>0&&(s[0].style.display=c),e)if(g[a].hasOwnProperty("legendLayer")&&(o=f.getLayer(g.legendLayer.id),i=o.visibleLayers,i.push(g[a].legendLayer),o.setVisibleLayers(i),o.show()),o=f.getLayer(a),g.treeCoverDensity.id===o.id&&C.publish("updateTCDRenderingRule"),g[a].hasLanguageSupport){var h="en"===p?0:"fr"===p?1:2;o.setVisibleLayers([h]),o.show()}else o&&o.show();else if(o=f.getLayer(a),o&&o.hide(),g[a].hasOwnProperty("legendLayer")){o=f.getLayer(g.legendLayer.id),i=o.visibleLayers;var m=y.indexOf(i,g[a].legendLayer);i.splice(m,1),o.setVisibleLayers(i),0===i.length&&o.hide()}},adjustLayerOpacity:function(e,a){var t=T.getMap(),i=t.getLayer(e);i&&i.setOpacity(a/100)},search:function(e,a){function t(e){var a,t=[],i=s;y.forEach(e,function(e,r){var o,n=0,s=h.itemInfo.itemData.operationalLayers;y.some(s,function(a){if(a.id==i){var t=a.layers;y.some(t,function(a){if(a.id==e.layerId){var t=a.popupInfo.title;t=t.match(/[^{]+(?=\})/g);var i=a.popupInfo.fieldInfos;y.some(i,function(e){t==e.fieldName&&(o=e.label)})}})}});for(name in e.feature.attributes)n++,name==o&&(a=e.feature.attributes[name]);var l=h.itemInfo.itemData.operationalLayers[0].layers;y.some(l,function(i){var o=e.layerId;if(o==i.id){var n=e.feature;t.push({name:e.value+" | "+e.layerName+": "+a,id:"result"+r,layerId:o,feature:n,layerName:e.layerName})}})});new f({data:t});l.byId("search").store.setData(t);var r=l.byId("search_popup");r.domNode.lastElementChild.parentNode.style.display="block"}var i,r=T.getMap(),n=o.getVM(),s=n.currentActiveLayer().id,c=r.getLayer(s).visibleLayers,d=r.getLayer(s).url,g=[],u=[],p=0,h=T.getWebMapResponse();y.forEach(c,function(e){g[e]=r.getLayer(s+"_"+e),i=g[e],i&&y.forEach(i.fields,function(e){"esriFieldTypeString"===e.type&&(u[p]=e.name,p++)})});var b=new m(d),L=new v;L.searchFields=u,L.layerIds=c,L.returnGeometry=!1,L.searchText=e,b.execute(L,t)},searchPopup:function(){var e=o.getVM(),a=T.getMap(),t=l.byId("search");if(null!=t.item){a.infoWindow.hide();var i=(t.item.layerName,t.item.feature.attributes),r=e.currentActiveLayer().id,n=r+"_"+t.item.layerId,s=a._layers[n],c=s.objectIdField,d=new D;d.returnGeometry=!0,d.where=c+"="+i[c],s.selectFeatures(d,X.SELECTION_NEW,function(e,t){var i;"polygon"==e[0].geometry.type&&(i=e[0].geometry.getExtent().getCenter(),a.setExtent(e[0].geometry.getExtent(),!0)),"point"==e[0].geometry.type&&(i=e[0].geometry,a.centerAt(i)),a.infoWindow.setFeatures(e),a.infoWindow.show(i)})}},showLoading:function(){h.remove("loading","dijitHidden"),h.remove("loadingMsg","dijitHidden")},hideLoading:function(){h.add("loading","dijitHidden"),h.add("loadingMsg","dijitHidden")},showError:function(){h.add("loadingMsg","dijitHidden"),h.remove("errorMsg","dijitHidden"),setTimeout(function(){h.add("loading","dijitHidden"),h.add("errorMsg","dijitHidden")},2e3)},sendAdminEmail:function(){var e="mailto:PDouard@wri.org?subject=Notifier la dernière session d’édition&body=(username) a une message pour vous";window.location.href=e},selectAll:function(){var e,a=T.getMap(),t=o.getVM(),i=t.currentActiveLayer().id,r=[],n=[],s=[];y.forEach(a.layerIds,function(t,o){if(a.getLayer(t).supportsDynamicLayers===!0&&a.getLayer(t).arcgisProps){r[o]=t,e=a.getLayer(t);var n=e.createDynamicLayerInfosFromLayerInfos();y.forEach(n,function(r,o){var n=o+1;s[n]=n,e.visibleLayers=s,e.setVisibleLayers(e.visibleLayers);var l=t+"_"+n,c=a._layers[l];c&&t==i&&c.show()})}});var l=b("#toolsContainer .dijitCheckBox");y.some(l,function(e,a){e.style.backgroundImage="url('app/images/ico-checkmark.png')",n[a]=a});var d=b("#layersCP .dijitCheckBox .dijitCheckBoxInput");y.some(d,function(e,a){e.checked!==!0&&(_.set(e,"aria-checked","true"),_.set(e,"checked",!0),dijit.byId("checkBoxDiv"+a)&&dijit.byId("checkBoxDiv"+a).set("checked",!0))});var g=b("#forestLossLayers .dijitCheckBox .dijitCheckBoxInput");y.forEach(g,function(e){e.checked!==!0&&(_.set(e,"aria-checked","true"),_.set(e,"checked",!0),dojo.byId(e.id)&&F.emit(dojo.byId(e.id),"click",{bubbles:!0,cancelable:!0}))});var u=b("#forestLossLayers .tools-container");y.forEach(u,function(e){c.set(e,"display","block")});var p=b("#forestCoverLayers .dijitCheckBox .dijitCheckBoxInput");y.forEach(p,function(e){e.checked!==!0&&(_.set(e,"aria-checked","true"),_.set(e,"checked",!0),dijit.byId(e.id)&&F.emit(dojo.byId(e.id),"click",{bubbles:!0,cancelable:!0}))});var f=b("#toolsContainer .title");y.some(f,function(e){e.style.color="#000"});var h=b("#toolsContainer .sliderContainer");y.some(h,function(e){e.style.display="block"});var m=b("#toolsContainer .sliderText");y.some(m,function(e){e.style.display="block"})},clearAll:function(){var e=T.getMap(),a=o.getVM();a.currentActiveLayer().id;y.forEach(e.layerIds,function(a){if(e.getLayer(a).supportsDynamicLayers===!0&&e.getLayer(a).arcgisProps){var t=e.getLayer(a),i=[];t.setVisibleLayers(i);var r=t.createDynamicLayerInfosFromLayerInfos();y.forEach(r,function(t,i){var r=i+1,o=a+"_"+r,n=e._layers[o];n&&n.hide()})}});var t=b("#toolsContainer .dijitCheckBox");y.some(t,function(e,a){e.style.backgroundImage="none"});var i=b("#layersCP .dijitCheckBox .dijitCheckBoxInput");y.some(i,function(e,a){_.set(e,"aria-checked","false"),_.set(e,"checked",!1),dijit.byId("checkBoxDiv"+a)&&dijit.byId("checkBoxDiv"+a).set("checked",!1)});var r=b("#forestLossLayers .dijitCheckBox .dijitCheckBoxInput");y.forEach(r,function(e){e.checked!==!1&&(_.set(e,"aria-checked","false"),_.set(e,"checked",!1),dojo.byId(e.id)&&F.emit(dojo.byId(e.id),"click",{bubbles:!0,cancelable:!0}))});var n=b("#forestLossLayers .tools-container");y.forEach(n,function(e){c.set(e,"display","none")});var s=b("#forestCoverLayers .dijitCheckBox .dijitCheckBoxInput");y.forEach(s,function(e){e.checked&&(_.set(e,"aria-checked","false"),_.set(e,"checked",!1),dijit.byId(e.id)&&F.emit(e,"click",{bubbles:!0,cancelable:!0}))});var l=b("#toolsContainer .title");y.some(l,function(e){e.style.color="#cfcfcf"});var d=b("#toolsContainer .sliderContainer");y.some(d,function(e){e.style.display="none"});var g=b("#toolsContainer .sliderText");y.some(g,function(e){e.style.display="none"})},mapUpdateEnd:function(e){var i=e.target,r=i.getLevel(),o=i.extent.getCenter(),n=o.getLatitude().toFixed(4),s=o.getLongitude().toFixed(4),l=a(),c=t.queryToObject(l);c.x=s,c.y=n,c.z=r,a(t.objectToQuery(c))},mapZoomEnd:function(e){var a=T.getMap(),t=o.getVM(),i=t.currentActiveLayer().id,r=a.getLayer(i),n=(r.visibleLayers,a.getScale()),s=r.minScale,l=r.maxScale,c=!1;c=s>=n&&n>=l?!1:!0,0===s&&0===l&&(c=!1),y.forEach(r.layerInfos,function(e,a){if(c)return void h.add("container"+a,"dijitHidden");var t=e.minScale,i=e.maxScale;return 0===t&&0===i?void h.remove("container"+a,"dijitHidden"):void(t>=n&&n>=i?h.remove("container"+a,"dijitHidden"):h.add("container"+a,"dijitHidden"))})},printReport:function(e,a){var i,s=T.getMap(),c=w.getVM(),d=o.getVM(),g=n.getConfig(),u=r.getVM(),p=s.infoWindow.getSelectedFeature(),f=p.getLayer(),h=f.objectIdField,b=(p.attributes[h],l.byId("basemapGallery").getSelected());if(b){var m=b.title.toLowerCase();switch(m=m.replace(/ +/g,"_")){case"openstreetmap":i="osm";break;case"oceans":i="oceans";break;case"national_geographic":i="national-geographic";break;case"light_gray_canvas":i="gray";break;case"terrain_with_labels":i="terrain";break;case"topographic":i="topo";break;case"streets":i="streets";break;case"imagery_with_labels":i="hybrid";break;case"imagery":i="satellite";break;case"dark_gray_canvas":i="dark-gray";break;case"usa_topo_maps":i="terrain";break;case"usgs_national_map":i="terrain"}}else i="topo";var v=f.url,L=s.getLayer(d.currentActiveLayer().id),k=L.visibleLayers,I=[];y.forEach(o.getVM().layersDrawingOption(),function(e){I.push(e.transparency)});var C={idField:h,idValue:p.attributes[h],basemap:i,title:c.title(),flagTitle:c.flagTitle(),flagPath:app.config.flagPath,webMap:g.webMapID,locale:c.currentLanguage(),visibleLayers:k.join(","),transparency:I.join(","),tcd:u.tcdSelectorValue()};if(v){var M=v.split("/"),j=M.pop(),V=M.join("/");C.mapService=V,C.layerId=j}else if(localStorage){var x={geometry:p.geometry,title:p.attributes.Custom_Title};localStorage.setItem("custom-feature",JSON.stringify(x))}else C.customGeo=JSON.stringify(p.geometry),C.customTitle=p.attributes.Custom_Title;var E=t.objectToQuery(C);window.open("printReport.htm?"+E,"_blank"),ga("A.send","event","Event","Print Report","User clicked the Print Report button in the infoWindow.")},popupToggle:function(e){var a=T.getMap();if(!a.infoWindow.features||0===a.infoWindow.features.length)return void b("#printReport").forEach(function(e){h.add(e,"dijitHidden")});b("#printReport").forEach(function(e){h.remove(e,"dijitHidden")});var t,i,r=d.byId("legislative");if(void 0!==e){var o=e.attributes,n=app.config.pdfURL;if(r&&(r.style.display="none"),!o)return;for(i in o)value=o[i],("doc_pdf"==i||"Doc_pdf"==i)&&(null===value&&r?r.style.display="none":(r&&(r.style.display="block",r.href=n+value+".pdf"),t=value));var s=b(".attrName");y.some(s,function(e){("doc_pdf"==e.innerHTML||"Doc_pdf"==e.innerHTML)&&(e.style.display="none")});var l=b(".attrValue");y.some(l,function(e){e.innerHTML==t&&(e.style.display="none")});for(i in o)value=o[i],("doc_pdf"==i||"Doc_pdf"==i)&&(null===value&&r?d.byId("legislative").style.display="none":r&&(d.byId("legislative").style.display="block",r.href=n+value+".pdf"))}}})});