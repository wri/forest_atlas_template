define(["declare","hash","ioquery","esri/map","arcgisutil","legend","identityManager","mainmodel","topic","construct","query","on","registry","array","uifactory","all","aspect","connect","mapconfig","mapevents","simplerenderer","simplefillsymbol","simplelinesymbol","simplemarkersymbol","color","graphicslayer","extent","spatialreference","keys","basemaplayer","tiledmap","esri/dijit/Popup","esri/config","atlas/tools/Helper","esri/layers/WebTiledLayer","esri/layers/RasterFunction","esri/layers/ImageParameters","esri/layers/ImageServiceParameters","esri/layers/ArcGISImageServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer"],function(e,a,r,n,i,t,o,s,l,p,c,d,m,y,u,f,L,v,g,w,_,b,S,I,O,h,E,T,P,R,C,D,M,W,k,F,Y,A,x,H){var z=e(null,{constructor:function(){var e=w.getEvents(),n=g.getConfig();y.forEach(n.corsEnabledServers,function(e){M.defaults.io.corsEnabledServers.push(e)}),M.defaults.map.panDuration=1,M.defaults.map.panRate=1,M.defaults.map.zoomDuration=100,M.defaults.map.zoomRate=1;var t=(n.webMapDefaults,app.config.webMapID),o=app.config.maskMapUrl,m=s.getVM();i.createMap(t,"map",{mapOptions:{spatialReference:{wkid:102100},force3DTransforms:!0,navigationMode:"css-transforms"}}).then(function(i){z._map=i.map;var t=r.queryToObject(a());t.x&&t.y&&t.z&&z._map.centerAndZoom([t.x,t.y],t.z),z._map.infoWindow.titleInBody=!1,m.initExtent(z._map.extent),z._webmapResponse=i;var u={snapKey:P.copyKey};z._map.enableSnapping(u),z._map.graphics.clear(),c(".esriSimpleSliderDecrementButton").forEach(function(a){var r=p.create("div",{id:"fullExtentDiv"},a,"before");d(r,"click",function(){l.publish(e.zoomToDefault)})});var f=new S(S.STYLE_SOLID,new O([255,0,0]),2),L=new b(b.STYLE_SOLID,new S(S.STYLE_SOLID,new O([255,0,0]),2),new O([255,255,0,.25])),g=new I(I.STYLE_CIRCLE,12,new S(S.STYLE_SOLID,new O([255,0,0]),2),new O([0,255,0,.25]));new _(f),new _(L),new _(g);z._map.on("click",function(a){l.publish(e.clickCoordinates,a)}),v.connect(z._map.infoWindow,"onSetFeatures",function(){l.publish(e.updateCustomInfoWindow)});var w=z._map.infoWindow,E=document.createDocumentFragment();y.forEach(w.domNode.children,function(e){e&&E.appendChild(e)}),document.getElementById("infoWindowData").appendChild(E);var T=app.config.defaultLayerTransparency/100,R=new A;R.renderingRule=new F(n.forestCoverLoss.rasterFunction);var D=new x(n.forestCoverLoss.url,{imageServiceParameters:R,id:n.forestCoverLoss.id,visible:!1,opacity:T}),M=new Y;M.layerOption=Y.LAYER_OPTION_SHOW,M.layerIds=n.activeFires.defaultLayers,M.format="png32";var W=new H(n.activeFires.url,{imageParameters:M,id:n.activeFires.id,opacity:T,visible:!1}),N=new x(n.treeCoverDensity.url,{id:n.treeCoverDensity.id,opacity:T,visible:!1}),G=new Y;G.layerOption=Y.LAYER_OPTION_SHOW,G.layerIds=n.landCover.defaultLayers,G.format="png32";var q=new H(n.landCover.url,{imageParameters:G,id:n.landCover.id,opacity:T,visible:!1}),B=new C(n.forestGainLayer.url,{id:n.forestGainLayer.id,opacity:T,visible:!1}),j=new Y;j.layerOption=Y.LAYER_OPTION_SHOW,j.layerIds=n.carbonLayer.defaultLayers,j.format="png32";var K=new H(n.carbonLayer.url,{imageParameters:j,id:n.carbonLayer.id,opacity:T,visible:!1}),U=new Y;U.layerOption=Y.LAYER_OPTION_SHOW,U.layerIds=n.intactForestLayer.defaultLayers,U.format="png32";var V=new H(n.intactForestLayer.url,{imageParameters:U,id:n.intactForestLayer.id,opacity:T,visible:!1}),Z=new Y;Z.layerOption=Y.LAYER_OPTION_SHOW,Z.layerIds=[],Z.format="png32";var J=new H(n.legendLayer.url,{imageParameters:Z,id:n.legendLayer.id,visible:!1}),Q=new C(o,{id:"maskLayer",opacity:.5}),X=new h({id:"customGraphicsLayer",visible:!0}),$=new k(n.landsatLayer.url,{copyright:n.landsatLayer.copyright,id:n.landsatLayer.id,visible:!1});z._map.addLayers([J,$,D,W,N,q,B,K,V,X]),d(z._map,"layers-add-result",function(){z._map.reorderLayer($,1),z._map.reorderLayer(N,2),z._map.reorderLayer(q,3),z._map.reorderLayer(V,4),z._map.reorderLayer(K,5)}),z._map.addLayer(Q),d(z._map,"layer-add-result",function(e){var a=e.layer;if(a.graphics){var r=a.id,n=s.getVM(),i=n.currentInfoTemplates();i[r]=a.infoTemplate,n.currentInfoTemplates(i),d(a,"selection-complete",function(e){e.target.graphics.length>0?n.currentSelectedLayers.push(e.target.id):n.currentSelectedLayers.remove(e.target.id)})}}),window.map=z._map;var ee=c(".actionsPane");ee[0].id="actionsPane";var ae=p.create("a",{id:"printReport","data-bind":"{text:printReport,click:clickPrintReport}",target:"_blank"},"actionsPane"),re=c(".actionList .action");re[0].innerHTML="",re[0].setAttribute("data-bind","{text:zoom}"),ae.innerHTML="Print Report",l.publish(e.UICreationComplete)})}});return z.initialize=function(){return z._instance||(z._instance=new z),z._instance},z.getMap=function(){return z._map},z.getWebMapResponse=function(){return z._webmapResponse},z});