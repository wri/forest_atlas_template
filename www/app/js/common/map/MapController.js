define(["declare","array","mapmodel","mapconfig","mainmodel","topic","on","hash","query","construct","connect","registry","all","string","memory","style","webMercatorUtils","dom","dojo/dom-class"],function(e,t,a,r,n,o,i,s,u,l,d,c,p,y,g,m,f,v,b){var h=[];return e(null,{zoomToDefault:function(){var e=n.getVM();require(["mapui"],function(t){var a=t.getMap();a.setExtent(e.initExtent())})},clickCoordinates:function(e){var t=f.webMercatorToGeographic(e.mapPoint),r=a.getVM();r.mapPoint(t);var n=this;require(["mapui"],function(t){t.getMap();e.graphic&&n.analyzeDrawnOrUploadedFeature(e.graphic)})},UICreationComplete:function(){var e=this;require(["toolsconfig","toolsevents","toolsui","legend","mapui","mainmodel","legend"],function(r,n,s,l,d,p,y){a.initialize("mapView"),r.initialize(),n.initialize(),s.initialize();var g=n.getEvents(),m=d.getMap(),f=p.getVM(),b=f.langType().toLowerCase(),h="",L=a.getVM();t.some(m.layerIds,function(e){return layerIdlower=e.toLowerCase(),h=e,layerIdlower.indexOf("_"+b)>-1}),L.currentActiveLayer(m.getLayer(h)),o.publish(g.mapZoomEnd),t.some(m.layerIds,function(e){e!=h&&e!=m.layerIds[0]&&m.getLayer(e).hide()}),m.getLayer("maskLayer").show(),i(m,"update-end",function(e){c.byId("legendDiv").refresh([{layer:L.currentActiveLayer(),title:""},{layer:m.getLayer("activeFires"),title:""},{layer:m.getLayer("landCover"),title:""},{layer:m.getLayer("legendLayer"),title:""},{layer:m.getLayer("carbonLayer"),title:""},{layer:m.getLayer("intactForestLayer"),title:""}]),o.publish(g.mapUpdateEnd,e)}),i(m,"zoom-end",function(e){o.publish(g.mapZoomEnd,e)}),u(".fires-toolbox div").forEach(function(t){i(t,"click",e.updateFiresLayer)}),i(v.byId("lossPlayButton"),"click",e.animateForestLossLayer.bind(e)),i(v.byId("lossStartYear"),"change",e.updateForestLossLayer),i(v.byId("lossEndYear"),"change",e.updateForestLossLayer),i(v.byId("landsat-checkbox"),"change",e.updateLandsatLayer)})},analyzeDrawnOrUploadedFeature:function(e){require(["mapui"],function(t){var a=t.getMap();a.infoWindow.setFeatures([e])})},popupTabChanged:function(){require(["toolsmodel"],function(e){var t,a=e.getVM(),r=v.byId("actionsPane");"popupAnalysisTab"===a.popupActiveTab()?l.place(r,"analysis-footer","first"):"popupDocumentTab"===a.popupActiveTab()?l.place(r,"document-footer","first"):(t=u(".esriPopupWrapper .sizer"),3===t.length&&(t=t[2],l.place(r,t,"first")))})},updateCustomInfoWindow:function(){var e=this;require(["mapui","atlas/tools/Helper","toolsmodel","dojo/dom-class"],function(a,r,n,o){var s,u,l,d,c,p,y=a.getMap(),g=y.infoWindow,f=n.getVM(),b=(g.selectedIndex||0)+1;return t.forEach(h,function(e){e.remove()}),g.features?("customGraphicsLayer"===g.features[0]._layer.id?(o.add("customPopupBody","draw-uploaded-feature"),f.popupActiveTab("popupAnalysisTab"),f.customFeatureShowing(!0),l=i.once(v.byId("deleteCustomFeature"),"click",function(){p=g.features[0],s=y.getLayer("customGraphicsLayer"),s&&p&&s.remove(p),m.set("customPopup","display","none"),g.hide()}),h.push(l),l=i(v.byId("editFeatureName"),"click",function(){p=g.features[0],o.contains("editFeatureName","isEditing")?(o.remove("editFeatureName","isEditing"),d=$("#newTitleInput").val(),p.attributes.Custom_Title=d,$("#results-header .title").html(d)):(o.add("editFeatureName","isEditing"),c=$("#results-header .title"),d=c.html(),u="<input id='newTitleInput' type='text' value='"+d+"' />",c.html(u))}),h.push(l)):(o.remove("customPopupBody","draw-uploaded-feature"),f.customFeatureShowing(!1)),f.popupIndex(b),f.popupCount(g.features.length),m.set("customPopup","display","block"),"popupAnalysisTab"===f.popupActiveTab()?(e.updateAnalysisTab(),e.popupTabChanged()):"popupDocumentTab"===f.popupActiveTab()&&(e.updateDocumentsTab(),e.popupTabChanged()),l=i.once(v.byId("customPopupClose"),"click",function(){m.set("customPopup","display","none"),g.hide()}),void h.push(l)):(m.set("customPopup","display","none"),void g.hide())})},updateAnalysisTab:function(){require(["toolsmodel","mapui","atlas/tools/Results","esri/tasks/query","esri/tasks/QueryTask"],function(e,t,a,r,n){var o=t.getMap().infoWindow,i=o.getSelectedFeature(),s=e.getVM(),l=(s.popupActiveTab(),{}),d=i.attributes.Custom_Title||o._title.innerHTML,c=u(".analysis-selection-types")[0];m.set("analysis-loader","top",c.offsetHeight+"px"),m.set("results-chart-container","top",c.offsetHeight+"px"),u("#results-header .title")[0].innerHTML=d;var p=document.querySelector(".analysis-options-select"),y=p.options[p.selectedIndex];if(s.currentAnalysisType()===s.restorationModuleType()&&(l={rasterId:y.getAttribute("data-id")}),i.attributes.OBJECTID){var g=i.attributes.OBJECTID,f=i._layer,v=f._url.path,b=new n(v),h=new r;h.objectIds=[g],h.outFields=["*"],h.returnGeometry=!0,h.maxAllowableOffset=0,b.execute(h,function(e){e.features.length>0?a.getResultsForType(s.currentAnalysisType(),e.features[0],l):a.getResultsForType(s.currentAnalysisType(),i,l)})}else a.getResultsForType(s.currentAnalysisType(),i,l)})},updateDocumentsTab:function(){require(["toolsmodel","mainmodel","mapui","esri/tasks/query","esri/tasks/QueryTask"],function(e,a,r,n,o){var i=r.getMap().infoWindow,s=i.getSelectedFeature(),l=a.getVM().currentLanguage(),d="en"===l?0:1,c=e.getVM(),p=s.attributes.Custom_Title||i._title.innerHTML;u("#popupDocument .title")[0].innerHTML=p,b.remove("documents-loader","hidden"),c.featureDocuments([]);var y=app.config.documentMapserver,g=app.config.documentDirectory;if(y||g){var m=new o(y+"/"+d),f=new n;f.geometry=s.geometry,f.outFields=["*"],f.returnGeometry=!1,m.execute(f,function(e){var a=[];t.forEach(e.features,function(e){e.attributes.url&&a.push({name:e.attributes.doc_titre||e.attributes.url,type:e.attributes.desc_type||"N/A",author:e.attributes.auteur||"N/A",year:e.attributes.date_doc?new Date(e.attributes.date_doc).getFullYear():"N/A",url:g+encodeURIComponent(e.attributes.url)})}),a.sort(function(e,t){return"N/A"===e.year?1:e.year<t.year?1:e.year>t.year?-1:0}),c.featureDocuments(a),b.add("documents-loader","hidden")},function(e){console.log(e)})}})},updateFiresLayer:function(e){require(["mapui"],function(t){var a,n=e.target?e.target:e.srcElement,o=u(".fires-toolbox div.active")[0],i=r.getConfig().activeFires,s=t.getMap(),l=i.defaultLayers.length,d=s.getLayer(i.id),c=new Date,p="",y=[];switch(b.remove(o,"active"),b.add(n,"active"),n.id){case"firesWeek":p="1 = 1";break;case"fires72":c.setDate(c.getDate()-4);break;case"fires48":c.setDate(c.getDate()-3);break;case"fires24":c.setDate(c.getDate()-2)}""===p&&(a=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds(),p="ACQ_DATE > date '"+a+"'");for(var g=0;l>g;g++)y[g]=p;d&&d.setLayerDefinitions(y)})},updateForestLossLayer:function(){require(["mapui","esri/layers/RasterFunction"],function(e,t){var a,n=document.getElementById("lossStartYear").selectedIndex,o=document.getElementById("lossEndYear").selectedIndex,i=r.getConfig().forestCoverLoss,s=e.getMap(),u=s.getLayer(i.id);n>o&&(n=o,document.getElementById("lossStartYear").selectedIndex=o),a=n===o?[n+1,o+1]:[n+1,o+2];var l=JSON.parse(JSON.stringify(i.rasterFunction));l.rasterFunctionArguments.Raster.rasterFunctionArguments.InputRanges=a,u&&u.setRenderingRule(new t(l))})},updateTCDRenderingRule:function(){var e=this;require(["mapui","esri/layers/RasterFunction","toolsmodel"],function(t,a,n){var o=r.getConfig().treeCoverDensity,i=o.rasterFunction,s=n.getVM(),u=t.getMap(),l=u.getLayer(o.id),d=[s.tcdSelectorValue(),101];i.rasterFunctionArguments.Raster.rasterFunctionArguments.InputRanges=d,l&&l.setRenderingRule(new a(i)),"popupAnalysisTab"===s.popupActiveTab()&&u.infoWindow.isShowing&&e.updateAnalysisTab()})},animateForestLossLayer:function(){function e(){b.remove(a,"playing"),clearInterval(window.lossInterval)}var t,a=document.getElementById("lossPlayButton"),r=document.getElementById("lossStartYear"),n=document.getElementById("lossEndYear"),o=r.selectedIndex,i=n.selectedIndex-1,s=1500,u=this;return b.contains(a,"playing")?void e():(b.add(a,"playing"),n.value=r.options[o].value,u.updateForestLossLayer(),void(window.lossInterval=setInterval(function(){return o>i?void e():(++o,t=n.options[o],void(t&&(n.value=t.value,u.updateForestLossLayer())))},s)))},updateLandsatLayer:function(){require(["toolsmodel","mapui"],function(e,t){var a,n,o,i=r.getConfig().landsatLayer,s=v.byId("landsat-checkbox"),u=e.getVM(),l=t.getMap();a=l.getLayer(i.id),s.checked?(n=i.urlBase+u.selectedLandsatYear()+i.urlTemplateSection,o=i.urlFragment+u.selectedLandsatYear()+i.urlTemplateSection,a.url=n,a.urlPath=o,a.urlTemplate=n,a.refresh(),a.visible||a.setVisibility(!0)):a.setVisibility(!1)})}})});