define(["esri/request","dojo/Deferred","root/analysis/analysisConfig"],function(e,t,r){var i="The requested image exceeds the size limit.",n=function(e){return 400===e.code&&e.details&&e.details.length>0&&e.details[0]===i},o=function(e){return function(t){return t*Math.pow(e,2)/1e4}},s=function(t,r,i,n){r.geometry&&(r.geometry=JSON.stringify(r.geometry)),r.renderingRule&&(r.renderingRule=JSON.stringify(r.renderingRule)),r.mosaicRule&&(r.mosaicRule=JSON.stringify(r.mosaicRule)),r.geometryType=r.geometryType||"esriGeometryPolygon",r.pixelSize=r.pixelSize||100,r.f=r.f||"json",e({url:t+"/computeHistograms",callbackParamName:"callback",content:r,handleAs:"json",timeout:3e4},{usePost:!0}).then(i,n)},u={getArithmeticRule:function(e,t,r){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:t,Operation:r}}}},a={multiplyRasters:function(e,i,a){var l=new t,g=100,m=function(e){e.histograms.length>0&&100!==g&&(e.histograms[0].counts=e.histograms[0].counts.map(o(g))),l.resolve(e)},c=function f(t){n(t)&&500!==g?(g=500,s(r.imageServer,{renderingRule:u.getArithmeticRule(e,i,3),geometry:a,pixelSize:g},m,f)):l.reject(t)};return s(r.imageServer,{renderingRule:u.getArithmeticRule(e,i,3),geometry:a,pixelSize:g},m,c),l}};return a});