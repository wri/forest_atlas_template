define(["esri/request","dojo/Deferred","root/analysis/rules","root/analysis/analysisConfig"],function(e,t,r,i){var n="The requested image exceeds the size limit.",o=function(e){return 400===e.code&&e.details&&e.details.length>0&&e.details[0]===n},s=function(e){return function(t){return t*Math.pow(e,2)/1e4}},u=function(e){return{input:3===e?[0,3,3,3]:[0,e,e,e,e+1,3],output:3===e?[0,1]:[0,1,0]}},l=function(t,r,i,n){r.geometry&&(r.geometry=JSON.stringify(r.geometry)),r.renderingRule&&(r.renderingRule=JSON.stringify(r.renderingRule)),r.mosaicRule&&(r.mosaicRule=JSON.stringify(r.mosaicRule)),r.geometryType=r.geometryType||"esriGeometryPolygon",r.pixelSize=r.pixelSize||100,r.f=r.f||"json",e({url:t+"/computeHistograms",callbackParamName:"callback",content:r,handleAs:"json",timeout:3e4},{usePost:!0}).then(i,n)},a={multiplyRasters:function(e,n,u){var a=new t,g=100,m=function(e){e.histograms.length>0&&100!==g&&(e.histograms[0].counts=e.histograms[0].counts.map(s(g))),a.resolve(e)},c=function y(t){o(t)&&500!==g?(g=500,l(i.imageServer,{renderingRule:r.getArithmeticRule(e,n,3),geometry:u,pixelSize:g},m,y)):a.reject(t)};return l(i.imageServer,{renderingRule:r.getArithmeticRule(e,n,3),pixelSize:g,geometry:u},m,c),a},slopeBreakdownAnalysis:function(e,n,a,g){var m,c,y=new t,f=100;c=u(e),m=r.getRemapRule(n,c.input,c.output),m=r.getArithmeticRule(m,a,3);var p=function(e){e.histograms.length>0&&100!==f&&(e.histograms[0].counts=e.histograms[0].counts.map(s(f))),y.resolve(e)},d=function h(e){o(e)&&500!==f?(f=500,l(i.imageServer,{renderingRule:m,geometry:g,pixelSize:f},p,h)):y.reject(e)};return l(i.imageServer,{renderingRule:m,pixelSize:f,geometry:g},p,d),y}};return a});