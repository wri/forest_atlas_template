define(["root/analysis/restoration-charts","root/analysis/compute-histogram","esri/geometry/geometryEngine","root/analysis/analysisConfig","root/analysis/constants","dojo/promise/all","dojo/dom-class","toolsmodel"],function(e,t,a,o,n,r,s,i){var l=function(e){return 0===e.length?e:e[0].counts},c=function(e,t){if(e.length===t)return e;for(var a=[],o=0;t>o;o++)a[o]=e[o]||0;return a},p=function(e,t,a){return e.map(function(e,o){return{name:t[o],data:[e],color:a[o]}}).filter(function(e){return 0!==e.data[0]&&"No Data"!==e.name})},m=function(e,t,a){return e.filter(function(e){return e[t]===a})[0]};return{performRestorationAnalysis:function(d,u){var h,f,g,y,O=i.getVM(),R=d.geometry,C=m(O.restorationModuleOptions(),"id",u),E={},A=o[n.SLOPE],_=o[n.LAND_COVER],v=o[n.POPULATION],T=o[n.TREE_COVER];if(u===A.id){var P=document.querySelector(".analysis-selection-types .slope-select");return s.remove(P,"hidden"),void this.performSlopeAnalysis(d)}var L=a.simplify(R);E[n.SLOPE]=t.multiplyRasters(A.id,u,L),E[n.LAND_COVER]=t.multiplyRasters(_.id,u,L),E[n.POPULATION]=t.multiplyRasters(v.id,u,L),E[n.TREE_COVER]=t.multiplyRasters(T.id,u,L),r(E).always(function(t){s.add("analysis-loader","hidden"),e.prepareContainer(O.restorationModuleChartTitlePrefix()+C.label);var a=app.config.slopeOptionNames.map(function(e){return e.label}),o=app.config.treeCoverOptionNames.map(function(e){return e.label});return h=c(l(t[n.SLOPE].histograms),a.length),f=c(l(t[n.LAND_COVER].histograms),_.classes.length),g=c(l(t[n.POPULATION].histograms),v.classes.length),y=c(l(t[n.TREE_COVER].histograms),o.length),h=p(h,a,app.config.slopeColors),f=p(f,_.classes,_.colors),g=p(g,v.classes,v.colors),y=p(y,o,app.config.treeCoverColors),t.code&&t.message||0===h.length||0===f.length||0===g.length||0===y.length?void e.showRestorationError(n.CHART_ID):(e.makeStackedBarChart(n.SLOPE_CHART_ID,A.name,h),e.makeStackedBarChart(n.LAND_COVER_CHART_ID,_.name,f),e.makeStackedBarChart(n.POPULATION_CHART_ID,v.name,g),void e.makeStackedBarChart(n.TREE_COVER_CHART_ID,T.name,y))})},performSlopeAnalysis:function(r){var p=o[n.SLOPE_BREAKDOWN],m=a.simplify(r.geometry),d=i.getVM(),u=d.slopeActiveOption(),h=app.config.slopeAnalysisRestorationOptions,f=app.config.slopeAnalysisRestorationColors;t.slopeBreakdownAnalysis(u.value,p.id,p.restorationOptionsId,m).then(function(t){s.add("analysis-loader","hidden");var a=l(t.histograms).slice(2),o=c(a,h.length),r=h.map(function(e,t){return d.slopeAnalysisRestorationOptionPrefix()+(t+1)}),i=[{name:p.chartName,data:o}];e.makeBarChart(n.CHART_ID,i,r,f,h),$(".highcharts-xaxis-labels text").each(function(e,t){var a=h[e];$("<title>"+a+"</title>").prependTo(t),$(t).html($(t).html())})},function(e){s.add("analysis-loader","hidden"),console.log(e)})}}});