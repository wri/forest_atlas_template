define(["root/analysis/restoration-charts","root/analysis/compute-histogram","esri/geometry/geometryEngine","root/analysis/analysisConfig","root/analysis/constants","dojo/promise/all","dojo/dom-class","toolsmodel"],function(e,a,s,t,o,r,n,i){var l=function(e){return 0===e.length?e:e[0].counts},c=function(e,a){if(e.length===a)return e;for(var s=[],t=0;a>t;t++)s[t]=e[t]||0;return s},d=function(e,a,s){return e.map(function(e,t){return{name:a[t],data:[e],color:s[t]}}).filter(function(e){return 0!==e.data[0]&&"No Data"!==e.name})};return{performRestorationAnalysis:function(m,h){var u,E,O,R,p=i.getVM(),_=p.restorationModuleOptions()[h],y=m.geometry,A=_.id,f={},C=t[o.SLOPE],g=t[o.LAND_COVER],T=t[o.POPULATION],P=t[o.TREE_COVER];if(_.id===C.id){var D=document.querySelector(".analysis-selection-types .slope-select");return n.remove(D,"hidden"),void this.performSlopeAnalysis(m)}var L=s.simplify(y);f[o.SLOPE]=a.multiplyRasters(C.id,A,L),f[o.LAND_COVER]=a.multiplyRasters(g.id,A,L),f[o.POPULATION]=a.multiplyRasters(T.id,A,L),f[o.TREE_COVER]=a.multiplyRasters(P.id,A,L),r(f).always(function(a){return n.add("analysis-loader","hidden"),e.prepareContainer(p.restorationModuleChartTitlePrefix()+_.label),a.code&&a.message?(e.showError(o.SLOPE_CHART_ID,C.name),e.showError(o.LAND_COVER_CHART_ID,g.name),e.showError(o.POPULATION_CHART_ID,T.name),void e.showError(o.TREE_COVER_CHART_ID,P.name)):(u=c(l(a[o.SLOPE].histograms),C.classes.length),E=c(l(a[o.LAND_COVER].histograms),g.classes.length),O=c(l(a[o.POPULATION].histograms),T.classes.length),R=c(l(a[o.TREE_COVER].histograms),P.classes.length),u=d(u,C.classes,C.colors),E=d(E,g.classes,g.colors),O=d(O,T.classes,T.colors),R=d(R,P.classes,P.colors),e.makeStackedBarChart(o.SLOPE_CHART_ID,C.name,u),e.makeStackedBarChart(o.LAND_COVER_CHART_ID,g.name,E),e.makeStackedBarChart(o.POPULATION_CHART_ID,T.name,O),void e.makeStackedBarChart(o.TREE_COVER_CHART_ID,P.name,R))})},performSlopeAnalysis:function(r){var d=t[o.SLOPE_BREAKDOWN],m=s.simplify(r.geometry),h=i.getVM(),u=h.slopeActiveOption(),E=app.config.slopeAnalysisRestorationOptions;a.slopeBreakdownAnalysis(u.value,d.id,d.restorationOptionsId,m).then(function(a){n.add("analysis-loader","hidden");var s=l(a.histograms).slice(2),t=c(s,E.length),r=E.map(function(e,a){return h.slopeAnalysisRestorationOptionPrefix()+(a+1)}),i=[{name:d.chartName,data:t}];e.makeBarChart(o.SLOPE_BREAKDOWN_CHART_ID,i,r),$(".highcharts-xaxis-labels text").each(function(e,a){var s=E[e];$("<title>"+s+"</title>").prependTo(a),$(a).html($(a).html())})},function(e){n.add("analysis-loader","hidden"),console.log(e)})}}});