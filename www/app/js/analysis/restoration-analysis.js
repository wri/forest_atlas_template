define(["root/analysis/restoration-charts","root/analysis/compute-histogram","esri/geometry/geometryEngine","root/analysis/analysisConfig","root/analysis/ethiopiaConfig","root/analysis/constants","dojo/promise/all","dojo/dom-class","toolsmodel"],function(a,e,s,o,t,r,n,i,l){var m=function(a){return 0===a.length?a:a[0].counts},c=function(a,e){if(a.length===e)return a;for(var s=[],o=0;e>o;o++)s[o]=a[o]||0;return s},d=function(a,e,s){return a.map(function(a,o){return{name:e[o],data:[a],color:s[o]}}).filter(function(a){return 0!==a.data[0]&&"No Data"!==a.name})};return{performRestorationAnalysis:function(l,h){var E=t.options[h],O=l.geometry,u=E.id,p={};if("SLOPE"===E.name){var R=document.querySelector(".analysis-selection-types .slope-select");return i.remove(R,"hidden"),void this.performSlopeAnalysis(l)}var _,y,C,A,f=o[r.SLOPE],g=o[r.LAND_COVER],T=o[r.POPULATION],L=o[r.TREE_COVER],P=s.simplify(O);p[r.SLOPE]=e.multiplyRasters(f.id,u,P),p[r.LAND_COVER]=e.multiplyRasters(g.id,u,P),p[r.POPULATION]=e.multiplyRasters(T.id,u,P),p[r.TREE_COVER]=e.multiplyRasters(L.id,u,P),n(p).always(function(e){return i.add("analysis-loader","hidden"),a.prepareContainer(E.name),e.code&&e.message?(a.showError(r.SLOPE_CHART_ID,f.name),a.showError(r.LAND_COVER_CHART_ID,g.name),a.showError(r.POPULATION_CHART_ID,T.name),void a.showError(r.TREE_COVER_CHART_ID,L.name)):(_=c(m(e[r.SLOPE].histograms),f.classes.length),y=c(m(e[r.LAND_COVER].histograms),g.classes.length),C=c(m(e[r.POPULATION].histograms),T.classes.length),A=c(m(e[r.TREE_COVER].histograms),L.classes.length),_=d(_,f.classes,f.colors),y=d(y,g.classes,g.colors),C=d(C,T.classes,T.colors),A=d(A,L.classes,L.colors),a.makeStackedBarChart(r.SLOPE_CHART_ID,f.name,_),a.makeStackedBarChart(r.LAND_COVER_CHART_ID,g.name,y),a.makeStackedBarChart(r.POPULATION_CHART_ID,T.name,C),void a.makeStackedBarChart(r.TREE_COVER_CHART_ID,L.name,A))})},performSlopeAnalysis:function(t){var n=o[r.SLOPE_BREAKDOWN],d=s.simplify(t.geometry),h=l.getVM(),E=h.slopeActiveOption();e.slopeBreakdownAnalysis(E.value,n.id,n.restorationOptionsId,d).then(function(e){i.add("analysis-loader","hidden");var s=m(e.histograms).slice(2),o=c(s,n.restorationOptions.length),t=n.restorationOptions.map(function(a){return a.label}),l=[{name:n.chartName,data:o}];a.makeBarChart(r.SLOPE_BREAKDOWN_CHART_ID,l,t),$(".highcharts-xaxis-labels text").each(function(a,e){var s=n.restorationOptions[a].tooltip;$("<title>"+s+"</title>").prependTo(e),$(e).html($(e).html())})},function(a){i.add("analysis-loader","hidden"),console.log(a)})}}});