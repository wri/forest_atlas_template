define(["root/analysis/restoration-charts","root/analysis/compute-histogram","esri/geometry/geometryEngine","root/analysis/analysisConfig","root/analysis/constants","dojo/promise/all","dojo/dom-class","toolsmodel"],function(e,t,a,s,o,n,r,i){var l=function(e){return 0===e.length?e:e[0].counts},c=function(e,t){if(e.length===t)return e;for(var a=[],s=0;t>s;s++)a[s]=e[s]||0;return a},d=function(e,t,a){return e.map(function(e,s){return{name:t[s],data:[e],color:a[s]}}).filter(function(e){return 0!==e.data[0]&&"No Data"!==e.name})},m=function(e,t,a){return e.filter(function(e){return e[t]===a})[0]};return{performRestorationAnalysis:function(h,u){var p,f,g,y,R=i.getVM(),O=h.geometry,E=m(R.restorationModuleOptions(),"id",u),A={},C=s[o.SLOPE],_=s[o.LAND_COVER],T=s[o.POPULATION],P=s[o.TREE_COVER];if(u===C.id){var v=document.querySelector(".analysis-selection-types .slope-select");return r.remove(v,"hidden"),void this.performSlopeAnalysis(h)}var L=a.simplify(O);A[o.SLOPE]=t.multiplyRasters(C.id,u,L),A[o.LAND_COVER]=t.multiplyRasters(_.id,u,L),A[o.POPULATION]=t.multiplyRasters(T.id,u,L),A[o.TREE_COVER]=t.multiplyRasters(P.id,u,L),n(A).always(function(t){return r.add("analysis-loader","hidden"),e.prepareContainer(R.restorationModuleChartTitlePrefix()+E.label),p=c(l(t[o.SLOPE].histograms),C.classes.length),f=c(l(t[o.LAND_COVER].histograms),_.classes.length),g=c(l(t[o.POPULATION].histograms),T.classes.length),y=c(l(t[o.TREE_COVER].histograms),P.classes.length),p=d(p,C.classes,C.colors),f=d(f,_.classes,_.colors),g=d(g,T.classes,T.colors),y=d(y,P.classes,P.colors),t.code&&t.message||0===p.length||0===f.length||0===g.length||0===y.length?void e.showRestorationError(o.CHART_ID):(e.makeStackedBarChart(o.SLOPE_CHART_ID,C.name,p),e.makeStackedBarChart(o.LAND_COVER_CHART_ID,_.name,f),e.makeStackedBarChart(o.POPULATION_CHART_ID,T.name,g),void e.makeStackedBarChart(o.TREE_COVER_CHART_ID,P.name,y))})},performSlopeAnalysis:function(n){var d=s[o.SLOPE_BREAKDOWN],m=a.simplify(n.geometry),h=i.getVM(),u=h.slopeActiveOption(),p=app.config.slopeAnalysisRestorationOptions,f=app.config.slopeAnalysisRestorationColors;t.slopeBreakdownAnalysis(u.value,d.id,d.restorationOptionsId,m).then(function(t){r.add("analysis-loader","hidden");var a=l(t.histograms).slice(2),s=c(a,p.length),n=p.map(function(e,t){return h.slopeAnalysisRestorationOptionPrefix()+(t+1)}),i=[{name:d.chartName,data:s}];e.makeBarChart(o.CHART_ID,i,n,f),$(".highcharts-xaxis-labels text").each(function(e,t){var a=p[e];$("<title>"+a+"</title>").prependTo(t),$(t).html($(t).html())})},function(e){r.add("analysis-loader","hidden"),console.log(e)})}}});