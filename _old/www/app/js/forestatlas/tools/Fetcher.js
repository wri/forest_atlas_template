define(["toolsmodel","toolsconfig","esri/request","dojo/Deferred","dojo/_base/lang","dojo/promise/all","esri/tasks/query","esri/tasks/QueryTask","atlas/tools/Renderer","atlas/tools/RuleUtils","esri/urlUtils"],function(e,t,r,s,n,i,o,a,l,u,g){"use strict";t.initialize();var c=!0,h=!1,m=t.getConfig(),d=m.analysisConfig,p=e.getVM(),y={getIntactForestLandscapes:function(e,t){this.debug("Fetcher >>> getIntactForestLandscapes");var r=new s,n=d.ifl,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!0,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!0,t)),o.length>0?i(o).then(function(e){r.resolve(e)}):r.resolve(),r.promise},getCarbon:function(e,t){this.debug("Fetcher >>> getCarbon");var r=new s,n=d.carbon,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!1,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!1,t)),o.length>0?i(o).then(function(e){r.resolve(e)}):r.resolve(),r.promise},getLandCover:function(e,t){this.debug("Fetcher >>> getLandCover");var r=new s,n=d.landCover,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!1,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!1,t)),o.length>0?i(o).then(function(e){r.resolve(e)}):r.resolve(),r.promise},getTreeCoverDensity:function(e,t){this.debug("Fetcher >>> getTreeCoverDensity");var r=new s,n=d.treeDensity,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!1,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!1,t)),o.length>0?i(o).then(function(e){r.resolve(e)}):r.resolve(),r.promise},getProtectedAreas:function(e,t){this.debug("Fetcher >>> getProtectedAreas");var r=new s,n=d.protectedArea,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!0,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!0,t)),o.length>0?i(o).then(function(){r.resolve(!0)}):r.resolve(),r.promise},getPrimaryForests:function(e,t){this.debug("Fetcher >>> getPrimaryForests");var r=new s,n=d.primForest,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!1,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!1,t)),o.length>0?i(o).then(function(){r.resolve(!0)}):r.resolve(),r.promise},getLegal:function(e,t){this.debug("Fetcher >>> getLegal");var r=new s,n=d.legal,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!1,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!1,t)),o.length>0?i(o).then(function(){r.resolve(!0)}):r.resolve(),r.promise},getPeat:function(e,t){this.debug("Fetcher >>> getPeat");var r=new s,n=d.peat,o=[];return c&&o.push(this.totalLossAnalysis(n,e,!0,t)),h&&o.push(this.clearanceAlertAnalysis(n,e,!0,t)),o.length>0?i(o).then(function(){r.resolve(!0)}):r.resolve(),r.promise},getRSPO:function(e,t){this.debug("Fetcher >>> getRSPO");var r=new s;d.rspo;return r.resolve(!0),r.promise},getFires:function(e,t){this.debug("Fetcher >>> getFires");var r,n,u=new s,g=d.fires;return r=new a(g.url+"/4"),n=new o,n.geometry=e.geometry,n.returnGeometry=!1,n.outFields=[""],n.where="1 = 1",i([r.execute(n)]).then(function(e){u.resolve(!0),l.renderFireData(e,t)}),u.promise},getLandCoverComposition:function(e,t){function r(e){o.resolve(!0),e.histograms.length>0?l.renderLandCoverComposition(e.histograms[0].counts,i.pixelSize,t):l.renderUnavailable(t)}function n(e){e.details&&"The requested image exceeds the size limit."===e.details[0]&&500!==i.pixelSize?(i.pixelSize=500,c.computeHistogram(u,i,r,n)):o.resolve(!1)}this.debug("Fetcher >>> getLandCoverComposition");var i,o=new s,a=d.landCover,u=d.totalLossAnalysisUrl,g=100,c=this;return i={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(e.geometry),pixelSize:g,mosaicRule:JSON.stringify(a.mosaicRule),f:"json"},this.computeHistogram(u,i,r,n),o.promise},getTotalGainAndLoss:function(e,t){function r(e){e&&e.histograms.length>0?c.resolve(e.histograms[0].counts):(l.renderUnavailable(t),c.resolve(!1))}function n(e){e.details&&"The requested image exceeds the size limit."===e.details[0]&&500!==g.pixelSize?(g.pixelSize=500,p.computeHistogram(h,g,r,n)):c.resolve(!1)}this.debug("Fetcher >>> getTotalGainAndLoss");var o,a,g,c=new s,h=d.totalLossAnalysisUrl,m=100,p=this;return a=u.getCurrentDensityRange(),o=u.getArithmeticRuleWithDensity(d.totalGain.rasterId,a),g={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(e.geometry),pixelSize:m,renderingRule:o,f:"json"},i([c,this.getTotalLoss(e,null,!0)]).then(function(e){l.renderTotalGainAndLossData(e[0],e[1],g.pixelSize,t)}),this.computeHistogram(h,g,r,n),c},getTotalLoss:function(e,t,r){function n(e){return r&&e&&e.histograms.length>0?void c.resolve(e.histograms[0].counts):(c.resolve(!0),void(e&&e.histograms.length>0?l.renderTotalLossData(e.histograms[0].counts,g.pixelSize,t):l.renderUnavailable(t)))}function i(e){e.details&&"The requested image exceeds the size limit."===e.details[0]&&500!==g.pixelSize?(g.pixelSize=500,p.computeHistogram(h,g,n,i)):c.resolve(!1)}this.debug("Fetcher >>> getTotalLoss");var o,a,g,c=new s,h=d.totalLossAnalysisUrl,m=100,p=this;return a=u.getCurrentDensityRange(),o=u.getArithmeticRuleWithDensity(d.totalLoss.rasterId,a),g={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(e.geometry),pixelSize:m,renderingRule:o,f:"json"},this.computeHistogram(h,g,n,i),c.promise},totalLossAnalysis:function(e,t,r,n){function i(t){g.resolve(!0),t.histograms.length>0?l.formatTreeCoverData(t.histograms[0].counts,a.pixelSize,e,m,r,n):l.renderUnavailable(n)}function o(e){e.details&&"The requested image exceeds the size limit."===e.details[0]&&500!==a.pixelSize?(a.pixelSize=500,f.computeHistogram(h,a,i,o)):g.resolve(!1)}var a,g=new s,c=d.totalLoss,h=d.totalLossAnalysisUrl,m=this.getEncoder(c.bounds,e.bounds),p=e.rasterRemap?e.rasterRemap:e.rasterId,y=r?m.getSimpleRule(c.rasterId,p):m.render(c.rasterId,p),f=this;return y=u.addRenderingRuleToDensity(y),a={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(t.geometry),renderingRule:y,pixelSize:t.geometry.rings.length>45?500:100,f:"json"},this.computeHistogram(h,a,i,o),g.promise},clearanceAlertAnalysis:function(e,t,r,n){function i(){console.log("Success"),c.resolve(!0)}function o(){console.log("Failure"),c.resolve(!0)}var a,l,u,g,c=new s,h=d.clearanceAlerts,m=d.clearanceAlertAnalysisUrl;return e.formaId&&(e.rasterId=e.formaId,e.includeFormaIdInRemap&&(e.rasterRemap.rasterFunctionArguments.Raster=e.formaId)),g=this.getEncoder(p.clearanceAlertBounds(),e.bounds),l=e.rasterRemap?e.rasterRemap:e.rasterId,a=r?g.getSimpleRule(h.rasterId,l):g.render(h.rasterId,l),u={geometryType:"esriGeometryPolygon",geometry:JSON.stringify(t.geometry),renderingRule:a,pixelSize:500,f:"json"},this.computeHistogram(m,u,i,o),c.promise},computeHistogram:function(e,t,s,n){var i=r({url:e+"/computeHistograms",content:t,handleAs:"json",callbackParamName:"callback",timeout:6e4},{usePost:!0});i.then(s,n)},getEncoder:function(e,t,r){var s=this;return{A:s.fromBounds(e),B:s.fromBounds(t),getSimpleRule:function(e,t){return JSON.stringify({rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:e,Raster2:t,Operation:3}})},renderRule:function(e,t){return{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:{rasterFunction:"Arithmetic",rasterFunctionArguments:{Raster:{rasterFunction:"Remap",rasterFunctionArguments:{InputRanges:[this.A[0],this.A[this.A.length-1]+1],OutputValues:[this.B.length],Raster:e,AllowUnmatched:!1}},Raster2:e,Operation:3}},Raster2:t,Operation:1}}},render:function(e,t){return JSON.stringify(this.renderRule(e,t))},encode:function(e,t){return this.B.length*e+t},decode:function(e){var t=e%this.B.length,r=(e-t)/this.B.length;return[r,t]}}},fromBounds:function(e){if(2!==e.length)return e;var t=[],r=e[0],s=e[1];for(r;s>=r;r++)t.push(r);return t},debug:function(e){console.log(e)}};return y});